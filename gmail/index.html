
<!DOCTYPE html>
<html>
  <head>
    <title>Gmail Signature Editor</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Gmail Signature Editor</p>
    <div id="htmlContentOut"  style="width:400px;height:200px;overflow:auto;"></div>
    <div id="htmlContent" contenteditable="true" style="width:1000px;height:300px;overflow:auto;border-style:solid;margin-bottom:10px;"></div>
    <button id="update_button" onclick="handleUpdateClick()">Update</button>
    <button id="saveupdate_button" onclick="handleSaveUpdateClick()">Save Update</button>
    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
    <pre id="content" style="white-space: pre-wrap;"></pre>
    <script type="text/javascript">
      const CLIENT_ID = '476074850902-2e2dqah57jr9c4jiqs21ufdas2uj4d4e.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyAIvYn1fzrCAxsuEDEgVYO-3mnpruZd2Cg';
      const DISCOVERY_DOCs = ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest','https://www.googleapis.com/discovery/v1/apis/oauth2/v1/rest'];
      const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.settings.basic https://www.googleapis.com/auth/gmail.settings.sharing';
      
      //https://admin.googleapis.com/admin/directory/v1/users/{userKey}

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;
      

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';
      document.getElementById('saveupdate_button').style.visibility = 'hidden';
      document.getElementById('update_button').style.visibility = 'hidden';
      document.getElementById('htmlContent').style.display = 'none';

      /**
       * Callback after api.js is loaded.
       */
      function gapiLoaded() {
        gapi.load('client', intializeGapiClient);
      }

      /**
       * Callback after the API client is loaded. Loads the
       * discovery doc to initialize the API.
       */
      async function intializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCs,
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      

      /**
       * Callback after Google Identity Services are loaded.
       */
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });

        console.log(google.accounts);   
        console.log(google.accounts.oauth2);
        console.log(google.accounts.oauth2.getAuthInstance);

        gisInited = true;
        maybeEnableButtons();
      }

      /**
       * Enables user interaction after all libraries are loaded.
       */
      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('authorize_button').innerText = 'Refresh';
       

          console.log(resp);

          let r=(await gapi.client.oauth2.userinfo.get()).result;
          console.log(r);
         
          await listAlias();
        };

        if (gapi.client.getToken() === null) {
          // Prompt the user to select a Google Account and ask for consent to share their data
          // when establishing a new session.
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // Skip display of account chooser and consent dialog for an existing session.
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick() {   
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('content').innerText = '';
          document.getElementById('authorize_button').innerText = 'Authorize';
          document.getElementById('signout_button').style.visibility = 'hidden';
          document.getElementById('saveupdate_button').style.visibility = 'hidden';
          document.getElementById('update_button').style.visibility = 'hidden';
          document.getElementById('htmlContent').style.display = 'none';
        }
      }
      function handleUpdateClick() {
        document.getElementById('htmlContent').innerText;
        let s=document.createElement("div");
        s.innerHTML=document.getElementById('htmlContent').innerText;
        let out=document.getElementById('htmlContentOut');
        out.innerText="";
        out.appendChild(s);
      }

      let sendAsEmail=null;
      let signature=null;
      async function listAlias() {

        let response;
        try {
          response = await gapi.client.gmail.users.settings.sendAs.list({
            'userId': 'craig@salcanpt.com'
          });
        } catch (err) {
          console.log(err);
          return;
        }
        const allAlias = response.result.sendAs;
        if (!allAlias || allAlias.length == 0) {
          document.getElementById('content').innerText = 'No labels found.';
          return;
        }
        sendAsEmail=null;
        signature=null;
        for(let i=0;i<allAlias.length;i++)if(allAlias[i].isPrimary==true){sendAsEmail=allAlias[i].sendAsEmail;signature=allAlias[i].signature;}
        if(signature)
        {
            let out=document.getElementById('htmlContentOut');
            out.innerText="";
            let s=document.createElement("div");
            s.innerHTML=signature;
            out.appendChild(s);
            document.getElementById('saveupdate_button').style.visibility = 'visible';
            document.getElementById('update_button').style.visibility = 'visible';
            document.getElementById('htmlContent').style.display = '';
            let inHtml=document.getElementById('htmlContent');
            inHtml.innerText=signature;
        }
        console.log(allAlias);
    }

    async function handleSaveUpdateClick() {

        console.log("signature:"+sendAsEmail);
        if(sendAsEmail)
        {
            console.log("signature!!!!");
            try {
                response = await gapi.client.gmail.users.settings.sendAs.patch({
                'userId': 'craig@salcanpt.com',
                'sendAsEmail': sendAsEmail,
                "signature": document.getElementById('htmlContent').innerText
            });
            console.log(response);
            } catch (err) {

                console.log(err);
                document.getElementById('content').innerText = err.message;
                return;
            }
        }
        
      }
      async function handleExampleClick(id)
      {
        let x=document.getElementById(id).innerHTML;
        x=x.replaceAll("Firstname","Craig");
        x=x.replaceAll("Lastname","Gorman");
        x=x.replaceAll("email@salcanpt.com","craig@salcanpt.com");
        x=x.replaceAll("+61400000000","+61447680379");
        document.getElementById('htmlContent').innerText=x;
        document.getElementById('htmlContentOut').innerHTML=x;
      }


    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <br>
    <p>Examples</p>
    <br>
    <button id="example1Button" onclick="handleExampleClick('example1')">Use Example 1</button>
    <div id="example1">
        <div style="width:300px;background-color:#343434;color:#dddddd">
        <div style="background-image:url(http://www.salcanpt.com/images/logo_192x50.png);width:72px;height:55px;float:left"></div>
        <p style="font-size:16px;margin:4px;padding-left:70px">Firstname Lastname</p>
        <p style="font-size:12px;margin:4px;padding-left:70px;color:#dddddd">
        <a href="mailto:email@salcanpt.com" style="color:#dddddd" target="_blank">email@salcanpt.com</a>
        </p>
        <p style="font-size:12px;margin:4px;padding-left:70px">+61400000000</p>
        </div>
    </div>
    <br>
    <br>
    <button id="example2Button" onclick="handleExampleClick('example2')">Use Example 2</button>
    <div id="example2">
        <div style="width:300px;">
        <div style="background-image:url(http://www.salcanpt.com/images/logo_192x50.png);width:72px;height:55px;float:left;background-color:#343434"></div>
        <p style="font-size:16px;margin:4px;padding-left:70px">Firstname Lastname</p>
        <p style="font-size:12px;margin:4px;padding-left:70px;">
        <a href="mailto:email@salcanpt.com" style="color:#1606a9" target="_blank">email@salcanpt.com</a>
        </p>
        <p style="font-size:12px;margin:4px;padding-left:70px">+61400000000</p>
        </div>
    </div>
    <br>
    <br>
    <button id="example3Button" onclick="handleExampleClick('example3')">Use Example 3</button>
    <div id="example3">
        <div style="width:300px;background-color:#747474;color:#dddddd;border-radius:10px;border-style:solid">
        <div style="background-image:url(http://www.salcanpt.com/images/logo_192x50.png);width:72px;height:55px;float:left;background-color:#343434"></div>
        <p style="font-size:16px;margin:4px;padding-left:70px;font-style:italic">Firstname Lastname</p>
        <p style="font-size:12px;margin:4px;padding-left:70px;color:#dddddd">
        <a href="mailto:email@salcanpt.com" style="color:#dddddd" target="_blank">email@salcanpt.com</a>
        </p>
        <p style="font-size:12px;margin:4px;padding-left:70px">+61400000000</p>
        </div>
    </div>
  </body>
</html>
<!-- [END gmail_quickstart] -->